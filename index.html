<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dr. Badge Designer</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configure Tailwind to use a custom font (Inter) -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary-blue': '#1e40af',
                        'secondary-gold': '#FFD700',
                        'secondary-silver': '#C0C0C0',
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom styles for professional feel */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7fa;
        }
        .card {
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        .badge-preview {
            border: 2px solid;
            padding: 1rem;
            text-align: center;
            font-size: 1.25rem;
            font-weight: 700;
        }
        .gold {
            background-color: #FFFAE6;
            border-color: #FFD700;
            color: #4B3800;
        }
        .silver {
            background-color: #F8F8F8;
            border-color: #C0C0C0;
            color: #333;
        }
        /* Style for style selection boxes */
        .style-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            padding-top: 1rem;
        }
        /* Loading Spinner Animation */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #1e40af;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen p-4 flex items-start justify-center">

    <div class="w-full max-w-4xl mt-10">
        <header class="text-center mb-10">
            <h1 class="text-4xl font-extrabold text-primary-blue mb-2">
                Professional Badge Designer
            </h1>
            <p class="text-gray-600">
                Customize your name badge order below. The prefix 'Dr.' is added automatically.
            </p>
        </header>

        <div id="orderContainer" class="card bg-white p-6 md:p-10 rounded-xl">
            <form id="badgeOrderForm" class="space-y-8">
                
                <!-- STEP 1: NAME ENTRY & LIVE PREVIEW -->
                <fieldset class="border-t pt-4">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-800">1. Badge Name</h2>
                    <div class="grid md:grid-cols-2 gap-6">
                        <!-- Name Input -->
                        <div>
                            <label for="userName" class="block text-sm font-medium text-gray-700 mb-2">Enter Full Name (e.g., Jane Doe):</label>
                            <input type="text" id="userName" name="userName" required 
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue transition duration-150" 
                                oninput="updateNameDisplay()" placeholder="Enter your name">
                        </div>

                        <!-- Live Preview -->
                        <div class="self-center">
                            <p class="text-sm font-medium text-gray-700 mb-2">Live Badge Text Preview:</p>
                            <div id="badgePreview" class="badge-preview gold rounded-lg transition duration-300">
                                <span id="finalBadgeName">Dr. [Your Name]</span>
                            </div>
                        </div>
                    </div>
                </fieldset>

                <!-- STEP 2 & 3: COLOR, QUANTITY, AND STYLE SELECTION -->
                
                <fieldset class="border-t pt-4 space-y-8">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-800">2. Order Details & Custom Styles (1-21)</h2>

                    <!-- GOLD BADGE ORDER -->
                    <div class="p-6 bg-yellow-50 rounded-xl border border-secondary-gold">
                        <h3 class="text-xl font-bold text-yellow-800 mb-4">Gold Badges</h3>
                        
                        <label for="goldQty" class="block text-sm font-medium text-gray-700 mb-2">Number of Gold Badges to order (0-10):</label>
                        <input type="number" id="goldQty" name="goldQty" min="0" max="10" value="0" 
                            class="w-full md:w-1/3 p-3 border border-gray-300 rounded-lg focus:ring-secondary-gold focus:border-secondary-gold transition duration-150" 
                            oninput="generateStyleInputs('gold')" onchange="generateStyleInputs('gold')">

                        <!-- QUICK STYLE SELECT FOR GOLD -->
                        <div class="mt-4 mb-4">
                            <label for="goldQuickStyle" class="block text-sm font-medium text-gray-700 mb-2">
                                Quick Apply Style to ALL Gold Badges:
                            </label>
                            <select id="goldQuickStyle" onchange="applyQuickStyle('gold')"
                                class="w-full md:w-1/2 p-3 border border-gray-300 rounded-lg focus:ring-secondary-gold focus:border-secondary-gold transition duration-150 bg-white">
                                <option value="">-- Optional: Select one style for all --</option>
                            </select>
                        </div>

                        <div id="goldStylesContainer" class="style-grid">
                            <!-- Style selectors dynamically inserted here -->
                        </div>
                    </div>

                    <!-- SILVER BADGE ORDER -->
                    <div class="p-6 bg-gray-100 rounded-xl border border-secondary-silver">
                        <h3 class="text-xl font-bold text-gray-700 mb-4">Silver Badges</h3>
                        
                        <label for="silverQty" class="block text-sm font-medium text-gray-700 mb-2">Number of Silver Badges to order (0-10):</label>
                        <input type="number" id="silverQty" name="silverQty" min="0" max="10" value="0" 
                            class="w-full md:w-1/3 p-3 border border-gray-300 rounded-lg focus:ring-secondary-silver focus:border-secondary-silver transition duration-150" 
                            oninput="generateStyleInputs('silver')" onchange="generateStyleInputs('silver')">
                        
                        <!-- QUICK STYLE SELECT FOR SILVER -->
                        <div class="mt-4 mb-4">
                            <label for="silverQuickStyle" class="block text-sm font-medium text-gray-700 mb-2">
                                Quick Apply Style to ALL Silver Badges:
                            </label>
                            <select id="silverQuickStyle" onchange="applyQuickStyle('silver')"
                                class="w-full md:w-1/2 p-3 border border-gray-300 rounded-lg focus:ring-secondary-silver focus:border-secondary-silver transition duration-150 bg-white">
                                <option value="">-- Optional: Select one style for all --</option>
                            </select>
                        </div>

                        <div id="silverStylesContainer" class="style-grid">
                            <!-- Style selectors dynamically inserted here -->
                        </div>
                    </div>
                </fieldset>

                <!-- SUBMIT BUTTON & FEEDBACK -->
                <div class="border-t pt-6">
                    <button type="submit" id="submitButton"
                        class="w-full py-3 bg-primary-blue hover:bg-blue-700 text-white font-bold rounded-lg transition duration-200 flex items-center justify-center space-x-2">
                        <span>Place Custom Order</span>
                        <div id="loadingSpinner" class="spinner hidden"></div>
                    </button>
                    
                    <!-- Submission Feedback Message Box -->
                    <div id="responseMessage" class="mt-4 p-3 rounded-lg text-center hidden" role="alert"></div>
                </div>
            </form>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const STYLES = Array.from({ length: 21 }, (_, i) => i + 1);
        
        // IMPORTANT: Replace this placeholder with your actual Google Apps Script Web App URL
        const GOOGLE_SHEET_ENDPOINT = 'https://script.google.com/macros/s/AKfycbxcfzf05osQjPwmTUngBR673tz0CsRBZv8SVTa5MkFG5ECTTrFzcFNhQftnV8VLmojrBQ/exec'; 
        
        // --- UI UTILITIES ---

        function showFeedback(type, message) {
            const msgBox = document.getElementById('responseMessage');
            msgBox.textContent = message;
            msgBox.classList.remove('hidden', 'bg-red-100', 'text-red-800', 'bg-green-100', 'text-green-800');
            
            if (type === 'success') {
                msgBox.classList.add('bg-green-100', 'text-green-800');
            } else if (type === 'error') {
                msgBox.classList.add('bg-red-100', 'text-red-800');
            }
        }

        function toggleLoading(isLoading) {
            const spinner = document.getElementById('loadingSpinner');
            const button = document.getElementById('submitButton');
            
            button.disabled = isLoading;
            if (isLoading) {
                spinner.classList.remove('hidden');
                button.querySelector('span').textContent = 'Submitting...';
            } else {
                spinner.classList.add('hidden');
                button.querySelector('span').textContent = 'Place Custom Order';
            }
        }

        /**
         * Helper function to populate style options (1-21) into a <select> element.
         */
        function populateStyleOptions(selectElement) {
            STYLES.forEach(style => {
                const option = document.createElement('option');
                option.value = style;
                option.textContent = `Style ${style}`;
                selectElement.appendChild(option);
            });
        }

        /**
         * Updates the badge name preview by adding the 'Dr.' prefix.
         */
        function updateNameDisplay() {
            const userNameInput = document.getElementById('userName');
            const finalNameSpan = document.getElementById('finalBadgeName');
            const name = userNameInput.value.trim();

            // Set the final displayed name with the required prefix
            if (name) {
                finalNameSpan.textContent = `Dr. ${name}`;
            } else {
                finalNameSpan.textContent = 'Dr. [Your Name]';
            }
        }

        /**
         * Applies the selected quick style to all individual badge style selectors of a given color.
         */
        function applyQuickStyle(color) {
            const quickSelect = document.getElementById(color + 'QuickStyle');
            const selectedStyle = quickSelect.value;
            const qty = parseInt(document.getElementById(color + 'Qty').value) || 0;
            
            if (selectedStyle && qty > 0) {
                // Loop through all generated individual selectors and set their value
                for (let i = 1; i <= qty; i++) {
                    const individualSelect = document.getElementById(`${color}Style_${i}`);
                    if (individualSelect) {
                        individualSelect.value = selectedStyle;
                    }
                }
            }
        }

        /**
         * Dynamically generates style dropdowns based on the quantity requested.
         */
        function generateStyleInputs(color) {
            const qtyInput = document.getElementById(color + 'Qty');
            const stylesContainer = document.getElementById(color + 'StylesContainer');
            const quantity = parseInt(qtyInput.value) || 0;
            
            const safeQuantity = Math.min(10, Math.max(0, quantity)); 
            const quickStyle = document.getElementById(color + 'QuickStyle').value;

            stylesContainer.innerHTML = ''; // Clear previous style inputs
            
            if (safeQuantity > 0) {
                for (let i = 1; i <= safeQuantity; i++) {
                    const wrapper = document.createElement('div');
                    wrapper.className = `p-3 rounded-lg border ${color === 'gold' ? 'border-secondary-gold bg-yellow-100' : 'border-secondary-silver bg-gray-200'}`;

                    const label = document.createElement('label');
                    label.htmlFor = `${color}Style_${i}`;
                    label.className = "block text-xs font-semibold mb-2";
                    label.textContent = `${color.charAt(0).toUpperCase() + color.slice(1)} Badge #${i} Style:`;
                    
                    const select = document.createElement('select');
                    select.name = `${color}Style_${i}`;
                    select.id = `${color}Style_${i}`;
                    select.className = "w-full p-2 border border-gray-400 rounded-md bg-white text-sm";
                    select.required = true;

                    const defaultOption = document.createElement('option');
                    defaultOption.value = "";
                    defaultOption.textContent = "Select Style (1-21)";
                    defaultOption.disabled = true;
                    if (!quickStyle) {
                        defaultOption.selected = true;
                    }
                    select.appendChild(defaultOption);

                    populateStyleOptions(select);

                    if (quickStyle) {
                        select.value = quickStyle;
                    }

                    wrapper.appendChild(label);
                    wrapper.appendChild(select);
                    stylesContainer.appendChild(wrapper);
                }
            }
        }
        
        // --- MAIN SUBMISSION LOGIC ---

        async function submitOrder(event) {
            event.preventDefault();

            if (GOOGLE_SHEET_ENDPOINT === 'YOUR_APPS_SCRIPT_WEB_APP_URL') {
                 showFeedback('error', 'Error: Please configure the GOOGLE_SHEET_ENDPOINT in the script before submitting.');
                 return;
            }

            toggleLoading(true);
            document.getElementById('responseMessage').classList.add('hidden');

            const form = event.target;
            const formData = new FormData(form);
            const finalName = document.getElementById('finalBadgeName').textContent;
            
            // 1. Process quantities and styles into a clean object
            const orderData = { 
                timestamp: new Date().toISOString(),
                finalBadgeName: finalName,
                goldOrder: [],
                silverOrder: []
            };

            const goldQty = parseInt(document.getElementById('goldQty').value) || 0;
            const silverQty = parseInt(document.getElementById('silverQty').value) || 0;

            for (let i = 1; i <= goldQty; i++) {
                const styleKey = `goldStyle_${i}`;
                orderData.goldOrder.push({
                    badgeNumber: i,
                    style: formData.get(styleKey) || 'N/A'
                });
            }

            for (let i = 1; i <= silverQty; i++) {
                const styleKey = `silverStyle_${i}`;
                orderData.silverOrder.push({
                    badgeNumber: i,
                    style: formData.get(styleKey) || 'N/A'
                });
            }

            // 2. Prepare the payload for Google Apps Script
            // We send the entire order object as a JSON string
            const payload = {
                method: 'POST',
                mode: 'no-cors', // Required for Google Apps Script Web Apps
                cache: 'no-cache',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(orderData)
            };

            // 3. Send the data to the Google Apps Script endpoint
            try {
                // Implementing simple retry mechanism for robustness
                let response = await fetchWithRetry(GOOGLE_SHEET_ENDPOINT, payload);

                // Note: GAS deployed as 'Web App' returns an opaque 'no-cors' response,
                // so we rely on the network status (no error thrown) for success.
                if (response.ok || response.type === 'opaque') {
                    showFeedback('success', `Order for ${finalName} successfully sent! Total items: ${goldQty + silverQty}.`);
                    form.reset(); // Clear the form after success
                    updateNameDisplay(); // Reset preview name
                    generateStyleInputs('gold'); // Reset dynamic fields
                    generateStyleInputs('silver');
                } else {
                    // This path might be rare due to no-cors mode, but handles fetch errors.
                    throw new Error(`Server returned status: ${response.status}`);
                }
            } catch (error) {
                console.error("Submission error:", error);
                showFeedback('error', `Submission failed. Please check the console and ensure the Apps Script URL is correct.`);
            } finally {
                toggleLoading(false);
            }
        }
        
        // Simple fetch retry mechanism
        async function fetchWithRetry(url, options, maxRetries = 3) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    return await fetch(url, options);
                } catch (error) {
                    if (i === maxRetries - 1) throw error; // Re-throw on last attempt
                    await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000)); // Exponential backoff
                }
            }
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            updateNameDisplay();
            
            // Populate the Quick Style Dropdowns
            populateStyleOptions(document.getElementById('goldQuickStyle'));
            populateStyleOptions(document.getElementById('silverQuickStyle'));

            // Initial generation of individual style inputs (will be 0 by default)
            generateStyleInputs('gold');
            generateStyleInputs('silver');

            // Form Submission Logic
            document.getElementById('badgeOrderForm').addEventListener('submit', submitOrder);
        });
    </script>
</body>
</html>


